---
import type { Fragment } from "astro/compiler-runtime";
import BaseLayout from "./BaseLayout.astro";
import Button from "@/components/bearnie/button/Button.astro";
import { ArrowLeft } from "@lucide/astro";
import type { MarkdownHeading } from "astro";
import ThemeToggle from "@/components/common/ThemeToggle.astro";

export interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  headings?: MarkdownHeading[];
}

// const { frontmatter } = Astro.props;
const { title, description, pubDate, updatedDate, headings } = Astro.props;

const formattedDate = new Date(pubDate).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const updatedDateFormatted = updatedDate
  ? new Date(updatedDate).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    })
  : null;
---

<BaseLayout title={title} description={description}>
  <section class="grid grid-cols-1 md:grid-cols-3 gap-8">
    <div class="flex justify-end items-start mt-0.5 md:p-10">
      <Button
        href="/blog"
        class="fixed z-10 m-4 my-32 md:m-0 bg-transparent backdrop-blur-sm shadow-md"
        variant="outline"
      >
        <ArrowLeft slot="left-icon" />
        <span
          class="hidden md:block text-neutral-600 dark:group-hover:text-neutral-200 dark:text-neutral-400"
          >Back to All
        </span>
      </Button>
      <slot name="column-1" />
    </div>
    <article>
      <header class="border-b pb-4">
        <h1
          class="sticky top-10 text-lg font-pixel-square tracking-tight dark:text-neutral-200"
        >
          {title}
        </h1>
        <!-- <p class="meta">
          Published on • {" "}<time class="text-sm">{formattedDate}</time>
          {
          updatedDateFormatted && (
          <time>
            {" "}
            • Updated on <time>{updatedDateFormatted}</time>
            </time>
            )
            }
            </p> -->
      </header>
      <main class="prose">
        <slot />
      </main>
    </article>
    <div class="relative flex font-sans m-10">
      <slot name="column-3" />
      {
        headings && headings.length > 0 && (
          <nav class="fixed outline-1 outline-neutral-200 dark:outline-neutral-700 rounded-2xl  px-6 py-4 hidden md:block">
            <h2 class="font-semibold text-sm mb-4 mt-2 text-foreground">
              On this page
            </h2>
            <ul class="space-y-2 text-sm">
              {headings.map((heading: MarkdownHeading) => (
                <li style={`padding-left: ${(heading.depth - 2) * 1}rem`}>
                  <a
                    href={`#${heading.slug}`}
                    class="text-muted-foreground hover:text-foreground transition-colors block line-clamp-1"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        )
      }
    </div>
  </section>
</BaseLayout>

<script>
  // Copy buttons for markdown code fences in prose
  function initProseCodeCopyButtons() {
    document.querySelectorAll(".prose pre").forEach((pre) => {
      if (pre.closest(".not-prose")) return;
      if (pre.closest("[data-codeblock]")) return;
      if (pre.closest("[data-component-preview]")) return;
      if (pre.parentElement?.hasAttribute("data-prose-code-wrapper")) return;

      const code = pre.querySelector("code");
      if (!code) return;

      const wrapper = document.createElement("div");
      wrapper.className = "relative";
      wrapper.setAttribute("data-prose-code-wrapper", "");
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      const button = document.createElement("button");
      button.type = "button";
      button.className =
        "absolute top-0 right-4 text-muted-foreground hover:text-foreground transition-colors z-10";
      button.title = "Copy to clipboard";

      button.innerHTML = `<svg>...</svg>`; // Add your copy icon SVG

      button.addEventListener("click", async () => {
        const text = code.textContent || "";
        try {
          await navigator.clipboard.writeText(text);
          // Show feedback
        } catch (err) {
          console.error("Failed to copy:", err);
        }
      });

      wrapper.appendChild(button);
    });
  }

  initProseCodeCopyButtons();
  document.addEventListener("astro:page-load", initProseCodeCopyButtons);

  function initTOC() {
    const tocLinks = document.querySelectorAll("nav a[href^='#']");
    if (!tocLinks.length) return;

    const headings = Array.from(
      document.querySelectorAll(".prose h2, .prose h3, .prose h4"),
    );

    const observer = new IntersectionObserver(
      () => {
        let activeHeading = null;
        for (const h of headings) {
          const rect = h.getBoundingClientRect();
          // Check if heading is above or near the top (150px buffer)
          if (rect.top < 250) {
            activeHeading = h;
          } else {
            break;
          }
        }

        if (activeHeading) {
          const id = activeHeading.getAttribute("id");
          tocLinks.forEach((link) => {
            link.classList.remove("text-foreground", "font-medium");
            link.classList.add("text-muted-foreground");
            if (link.getAttribute("href") === `#${id}`) {
              link.classList.remove("text-muted-foreground");
              link.classList.add("text-foreground", "font-medium");
            }
          });
        }
      },
      { rootMargin: "0px 0px -80% 0px" },
    );

    headings.forEach((h) => observer.observe(h));
  }

  initTOC();
  document.addEventListener("astro:page-load", initTOC);
</script>

<style>
  article {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  header {
    margin-bottom: 2rem;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 1rem;
  }

  h1 {
    margin: 0 0 1rem 0;
    font-size: 2.5rem;
  }

  .meta {
    color: #666;
    font-size: 1rem;
    margin: 0;
  }

  footer {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #e0e0e0;
  }

  footer a {
    color: #0066cc;
    text-decoration: none;
  }

  footer a:hover {
    text-decoration: underline;
  }
</style>
